<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="utf-8">
    <title>频繁模式挖掘</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/css/bootstrap.min.css">

    <link rel="stylesheet"
          href="https://cdn.jsdelivr.net/npm/bootstrap-select@1.13.9/dist/css/bootstrap-select.min.css">
    <!-- font -->
    <link rel="stylesheet" th:href="@{/vendor/font-awesome/css/font-awesome.min.css}">
    <!-- theme stylesheet-->
    <link rel="stylesheet" th:href="@{/css/style.default.css}" id="theme-stylesheet">
</head>
<body>
<!-- 侧边栏 -->
<nav th:fragment="sideBar" class="side-navbar">
    <div class="side-navbar-wrapper">
        <!-- Sidebar Header  -->
        <div class="sidenav-header d-flex align-items-center justify-content-center">
            <!-- User Info-->
            <div class="sidenav-header-inner text-center"><img th:src="@{/imgs/fac.jpg}" alt="person"
                                                               class="img-fluid rounded-circle">
                <h2 class="h5">aaa</h2><span>aaa</span>
            </div>
        </div>
        <!-- Sidebar Navigation Menus-->
        <div class="main-menu">
            <h5 class="sidenav-heading">主要功能</h5>
            <ul id="side-main-menu" class="side-menu list-unstyled">
                <li><a href="#">检索功能</a></li>
                <li><a class="active" href="#">频繁模式</a></li>
                <li><a href="charts.html">待定</a></li>
                <li><a href="tables.html">待定</a></li>
            </ul>
        </div>
    </div>
</nav>
<div class="page">
    <!-- 顶部栏-->
    <header th:fragment="headBar" class="header">
        <nav class="navbar">
            <div class="container-fluid">
                <div class="navbar-holder d-flex align-items-center justify-content-between">
                    <div class="navbar-header">
                        <div class="brand-text d-none d-md-inline-block"><strong class="text-primary">系统名称</strong>
                        </div>
                    </div>
                    <ul class="nav-menu list-unstyled d-flex flex-md-row align-items-md-center">
                        <!-- Log out-->
                        <li class="nav-item"><a href="#" class="nav-link logout"> <span
                                class="d-none d-sm-inline-block">退出登录</span><i class="fa fa-sign-out"></i></a></li>
                    </ul>
                </div>
            </div>
        </nav>
    </header>
    <!--main body-->
    <main role="main" class="pt-3 px-4">
        <div class="card col-lg-10">
            <div class="card-body">
                <form>
                    <label>选择源文件:</label><br/>
                    <select class="selectpicker" id="fileSelector" name="fileSelector">
                        <option th:each="file:${fileList}"
                                th:text="${file}"
                                th:selected="${file}"
                                th:name="${file}"></option>
                    </select>
                    <input type="button" class="btn btn-primary" value="执行算法" onclick="changeFile()">
                </form>
            </div>
            <div class="card-body">
                <form id="fileUploadForm" action="/data/upload" method="post" enctype="multipart/form-data"
                      target="tgFrame">
                    <div class="form-group">
                        <label for="uploadFile">选择要上传的文件</label>
                        <input class="form-control-file" id="uploadFile" name="uploadFile" accept="*/*" type="file">
                        <br/>
                        <input class="btn btn-primary" type="button" value="上传" onclick="fileUploadSubmit()">
                    </div>
                </form>
                <iframe id="tgFrame" name="tgFrame" src="about:blank" style="display: none"></iframe>
            </div>
        </div>
        <div class="card col-lg-10">
            <div class="card-body">
                <div style="height: 960px; width: 100%">
                    <div id="graphChart_main" class="mainChart" style="height: 100%; width: 75%; float: left"></div>
                    <div id="paramSet_graph" class="paramSet_graph" style="float: left; width: 20%; padding-left: 20px">
                        <label>Min Support:</label>
                        <input class="form-control" id="minSupport"><br/>
                        <label>Min Confidence:</label>
                        <input class="form-control" id="minConfidence"><br/>
                        <label>Differential Privacy</label>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="dpRadio" id="dpRadioOn" value="ON" checked>
                            <label class="form-check-label" for="dpRadioOn">启用</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="dpRadio" id="dpRadioOff" value="OFF">
                            <label class="form-check-label" for="dpRadioOff">停用</label>
                        </div>
                        <br/>
                        <input type="button" class="btn btn-primary" id="btn_data_refresh" value="刷新" onclick="dataReload()">
                    </div>
                </div>
            </div>
        </div>
        <div class="card col-lg-10">
            <div class="card-body">
                <div style="height: 400px; width: 100%">
                    <div id="barChart_detail_model" class="subChart" style="width: 45%; height: 100%; margin: 2px; float: left"></div>
                    <div id="scatterChart_detail_conf_lift" class="subChart" style="width: 45%; height: 100%; float: left"></div>
                </div>
            </div>
        </div>
    </main>
    <!--底部栏-->
    <footer th:fragment="footer" class="main-footer">
        <div class="container-fluid">
            <div class="row">
                <div class="col-sm-6">
                    <p>演示程序</p>
                </div>
            </div>
        </div>
    </footer>
</div>

<script src="https://cdn.jsdelivr.net/npm/jquery@3.5.1/dist/jquery.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap-select@1.13.9/dist/js/bootstrap-select.min.js"></script>
<!-- echarts -->
<script src="https://cdn.bootcss.com/echarts/5.0.0/echarts.min.js"></script>

<script>

    var GraphChart_Main = echarts.init(document.getElementById('graphChart_main'));
    var BarChart_Details_Model = echarts.init(document.getElementById('barChart_detail_model'));
    var ScatterChart_Details_Conf_lift = echarts.init(document.getElementById('scatterChart_detail_conf_lift'));

    var Btn_Data_Refresh = document.getElementById('btn_data_refresh');

    function renderColor() {
        return "#" + (Math.random() * 0xffffff << 0).toString(16);
    }

    /**
     * itemSets: main dataSet for FI
     * item structure: {items: String, support: double, id<assigned when required>: int}
     * item example: {items: "[防风]", support: 0.88234, id:5}
     * @type {*[]}
     */
    var itemSets = [];

    /**
     * FrequentModels: main dataSet for FM
     * item structure<corresponding to DTO>: {source: String, target: String, confidence: double, lift: double}
     * item example: {source: "[防风]", target: ["黄岑"], confidence: 0.3211355, lift: 1.54223}
     * @type {*[]}
     */
    var FrequentModels = [];

    var dataCount;

    var idPool = 0;

    var targetFile;

    //get frequent item set information
    $.ajax({
        url: "/data/fpMain",
        type: "GET",
        dataType: "json",
        data: {},
        success: function (data) {
            basicDataFill(data);
            targetFile = "asthma.csv"
        }
    })

    function dataReload() {
        var minSupport = document.getElementById('minSupport').value;
        var minConfidence = document.getElementById('minConfidence').value;
        $.ajax({
            url: "/data/fpMainUser",
            type: "GET",
            dataType: "json",
            data: {
                minSupport: minSupport,
                minConfidence: minConfidence,
                userFile: targetFile,
            },
            success: function (data) {
                basicDataFill(data);
            }
        })
    }

    function basicDataFill(data) {
        idPool = 0;
        itemSets = [];
        FrequentModels = [];
        dataCount = data.count;

        var items = data.itemSets;
        var models = data.models;
        for (var i in items) {
            var item = {};
            item.items = items[i].items;
            item.support = items[i].support;
            item.id = idPool++;
            itemSets.push(item);
        }
        console.log(itemSets);
        for (var i in models) {
            FrequentModels.push(models[i]);
            // console.log(renderColor());
            // if (itemSets[data[i].source] == null) {
            //     itemSets[data[i].source] = renderColor();
            // }
            // if (itemSets[data[i].target] == null) {
            //     itemSets[data[i].target] = renderColor();
            // }
        }
        console.log(FrequentModels);
        renderRelationshipChart();
        // renderInit();
    }

    function renderRelationshipChart() {

        GraphChart_Main.clear();

        nodes = []
        links = []

        for (var i in itemSets) {
            var node = {};
            node.id = itemSets[i].id;
            node.name = itemSets[i].items;
            node.value = itemSets[i].support * 1.0 / dataCount;
            node.x = -400 + Math.random() * 700;
            node.y = -300 + Math.random() * 500;
            node.symbolSize = (100.0 * itemSets[i].support / dataCount);
            nodes.push(node);
        }

        for (var i in FrequentModels) {
            var link = {};
            for (var j in itemSets) {
                if (FrequentModels[i].source == itemSets[j].items) {
                    link.source = itemSets[j].id.toString();
                }
                if (FrequentModels[i].target == itemSets[j].items) {
                    link.target = itemSets[j].id.toString();
                }
            }
            links.push(link);
        }

        option = {
            title: {
                text: '关系图',
                subtext: 'powered by echart',
                left: '1%',
            },
            series: [{
                name: 'support',
                type: 'graph',
                data: nodes,
                links: links,
                edgeSymbol: ['none', 'arrow'],
                scaleLimit: {
                    min: 0.4,
                    max: 2,
                },
                lineStyle: {
                    color: 'source',
                    curveness: 0.3,
                },
                label: {
                    show: true,
                    formatter: '{b}'
                },
                layout: 'force',
                force: {
                    repulsion: 100,
                    edgeLength: [10, 100],
                },
                roam: true,
            }],
            tooltip: {
                show: true,
                trigger: 'item',
                triggerOn: 'mousemove | click',
                backgroundColor: 'rgba(210,210,210,0.7)',
                textStyle: {
                    color: '#000',
                    fontStyle: 'normal',
                }
            },
        }

        GraphChart_Main.setOption(option);
        GraphChart_Main.on('click', function (params) {
            if (params.dataType == 'node') {
                coreNode = params.data.name;
                detail = {};
                detail["nodeName"] = coreNode;
                detail["dimension"] = ['confidence', 'lift', 'models'];
                detail["dataSet"] = [];
                detail.dataSet.push(detail.dimension);
                for (var i in FrequentModels) {
                    if (FrequentModels[i].source == coreNode || FrequentModels[i].target == coreNode) {
                        data = [];
                        data.push(FrequentModels[i].confidence);
                        data.push(FrequentModels[i].lift);
                        data.push(FrequentModels[i].source + '=>' + FrequentModels[i].target);
                        detail.dataSet.push(data);
                    }
                }
                console.log(detail);
                renderDetailModels(detail);
            }
        })
    }

    function renderDetailModels(params) {
        BarChart_Details_Model.setOption({});
        option_bar = {
            title: {
                text: "相关频繁模式",
                subtext: "display for: " + params.nodeName,
            },
            dataset: [{
                source: params.dataSet,
            }, {
                transform: {
                    type: 'sort',
                    config: {
                        dimension: 'confidence',
                        order: 'desc',
                    },
                }
            }],
            xAxis: {
                type: 'category',
                show: false,
            },
            yAxis: {
                name: '置信度',
                nameLocation: 'start'
            },
            series: {
                type: 'bar',
                encode: {
                    x: 'models',
                    y: 'confidence',
                },
                datasetIndex: 1,
            },
            tooltip: {
                trigger: 'item'
            }
        }


        var schema = [
            {name: 'confidence', index: 0, text: '置信度'},
            {name: 'lift', index: 1, text: '提升度'},
            {name: 'model', index: 2, text: '频繁模式'},
        ]

        option_scatter = {
            title : {
                text: "置信度-提升度",
                subtext: "display for: " + params.nodeName,
                left: '65%'
            },
            xAxis: {
                type: "value",
                name: "置信度",
                nameLocation: "middle",
                nameGap: 35,
                min: 0.7,
            },
            yAxis: {
                type: "value",
                name: "提升度",
                min: 2,
            },
            series: {
                type: "scatter",
                data: params.dataSet,
                symbolSize: 20,
            },
            tooltip: {
                trigger: 'item',
                triggerOn: 'mousemove|click',
                padding: 5,
                borderWidth: 1,
                formatter: function (obj) {
                    var value = obj.value;
                    return schema[2].text + ': ' + value[2] + '<br>'
                        + schema[0].text + ': ' + value[0] + '<br>'
                        + schema[1].text + ': ' + value[1] + '<br>';
                }
            }
        }

        ScatterChart_Details_Conf_lift.setOption(option_scatter);
        BarChart_Details_Model.setOption(option_bar);
    }

    function fileUploadSubmit() {
        document.getElementById('fileUploadForm').submit();
        alert('上传成功！');
    }

    function changeFile() {
        targetFile = document.getElementById('fileSelector').value;
        dataReload();
    }
</script>

</body>
</html>